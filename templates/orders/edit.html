{% extends "base.html" %}

{% block extrahead %}{{ block.super }}
    <script type='application/javascript'>
        $(function(){
            $('.specify').each(function(){
                if(this.checked){
                    $(this).change()
                }
            });
            
		    var availableTags = [
			    {label:'CAR1200', value:'CAR1200', id:'1'},
			    {label:'REC1100', value:'REC1100', id:'2'}
		    ];
		    $( "#search" ).autocomplete({
			    source: availableTags,
			    select: function( event, ui ) {
			        alert(ui.item.id);
				    addstyle('g1', ui.item.id)
			    }
		    });
		    $('.stylecontainer').sortable({
		        handle: 'div.move',
		        connectWith: '.stylecontainer',
		        update: function(event, ui){
		            if(ui.sender){
		                var styleprefix = $(ui.item).attr('data-prefix');
		                var parentprefix = $(this).parent().attr('id');
		                $('#id_' + styleprefix + '-parentprefix').val(parentprefix);
		            }
		        }
	        })
	        $('.move').disableSelection();
        });
        
        function addgroup(){
            var groupprefix = parseInt($('#id_groupcount').val()) + 1;
            $.get('/tsd/orders/addgroup/', {'orderid':'1', 'prefix':groupprefix}, function(data){
                $('#groups').append(data);
                $('#id_groupcount').val(groupprefix);
                //addsetup('g'+groupprefix);
            });
        }
        
        function addgroupimprint(groupprefix){
            var prefix = parseInt($('#id_setupcount').val()) + 1;
            $('.grouplist').each(function(index){
                parentprefix = $(this).attr('data-imprint');
                $.get('/tsd/orders/addsetup/', {'prefix':prefix, 'parentprefix':parentprefix, 'groupprefix':groupprefix}, function(data){
                    $('#' + parentprefix + 'setups').append(data);
                    $('#id_groupimprintcount').val(prefix);
                });
            });
        }
        
        function displaystyles(groupprefix){
            $('#addstylegroup').val(groupprefix);
            togglestyles();
        }
        
        function addstyle(styleid){
            var groupprefix = $('#addstylegroup').val();
            var styleprefix = parseInt($('#id_stylecount').val()) + 1;
            var sizeprefix = parseInt($('#id_sizecount').val()) + 1;
            $.get('/tsd/orders/addstyle/', {'styleid':styleid, 'groupprefix':groupprefix, 'styleprefix':styleprefix, 'sizeprefix':sizeprefix}, function(data){
                $('#styles' + groupprefix).append(data);
                $('#id_stylecount').val(styleprefix);
                var newsizecount = sizeprefix - 1 + parseInt($('#s' + styleprefix + 'sizecount').html());
                $('#id_sizecount').val(newsizecount);
            });
        }
        
        function addimprint(){
            var prefix = parseInt($('#id_imprintcount').val()) + 1;
            $.get('/tsd/orders/addimprint/', {'prefix':prefix, 'customerid':$('#id_customer').val()}, function(data){
                $('#imprints').append(data);
                $('#id_imprintcount').val(prefix);
            });
        }
        
        function addservice(){
            var prefix = parseInt($('#id_servicecount').val()) + 1;
            $.get('/tsd/orders/addservice/', {'prefix':prefix}, function(data){
                $('#services').append(data);
                $('#id_servicecount').val(prefix);
            });
        }
        
        function changegroupname(prefix, value){
            $(".grouplist option[value='" + prefix + "']").html(value);
        }
        
        function togglegroups(prefix){
            $('#' + prefix + 'groups').toggle();
        }
        
        function deletegroup(prefix){
            deleteitem(prefix)
            $(".grouplist[value!='" + prefix + "'] option[value='" + prefix + "']").remove();
        }
        
        function deleteitem(prefix){
            $('#id_' + prefix + '-delete').val('1');
            $('.' + prefix).hide();
        }
        
        function togglestyles(){
            $('#stylelist').toggle();
        }
    </script>
    
    <style type='text/css'>
        .hidden{
            display:none;
        }
        #stylelist{
            position:absolute;
            right:0px;
            height:100%;
            width:400px;
            background-color:gray;
            color:white;
            display:none;
        }
        #closestyles{
            position:absolute;
            top:5px;
            right:5px;
        }
        .stylelistitem{
            cursor:pointer;
        }
        .stylelabel, .stylecolor, .stylesize, .styledelete{
            display: inline-block;
            padding-right: 5px;
        }
        .stylelabel{
            width: 200px;
            margin-left: 12px;
        }
        .stylesize{
        
        }
        #styles{
            padding-left: 13px;
        }
        .stylecontainer{
            min-height:20px;
        }
        .style{
            position: relative;
        }
    </style>
{% endblock %}

{% block content %}
    <div id='stylelist'>
        <input type='button' id='closestyles' value='Close' onClick='togglestyles()'/>
        <input type='hidden' id='addstylegroup'/>
        {% regroup stylelist by manufacturer as manufacturers %}
            <ul>
            {% for manufacturer in manufacturers %}
                <li>
                    {{ manufacturer.grouper }}
                    <ul>
                        {% for style in manufacturer.list %}
                            <li class='stylelistitem' onClick='addstyle({{ style.pk }})'>{{ style }}</li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
            </ul>
                
    </div>
    <input id='search'/ style='display:none;'>
    <form method="post" action="">
    {% csrf_token %}
        {{ form.errors }}
        <p>Job Name: {{ form.name }}{{ form.customer }}</p>
        <fieldset>
            <legend>Imprints <input type='button' onClick='addimprint();' value='+'/></legend>
            <table id='imprints'>
                <tr>
                    <td>Location</td>
                    <td># of Colors</td>
                    <td>Name</td>
                    <td>Print</td>
                    <td>Setup</td>
                    <td>Specify</td>
                </tr>
                {% include 'orders/imprint.html' %}
            </table>
        </fieldset>
        <fieldset>
            <legend>Styles <input type='button' onClick="displaystyles('');" value='+'/></legend>
            <div id='styles' class='stylecontainer'>
                {% for styledic in styledics %}
                    {% if '' == styledic.parentprefix %}
                        {% include 'orders/style.html' %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class='clear'></div>
            <div id='groups'>
                {% include 'orders/group.html' %}
            </div>
        </fieldset>
        <fieldset>
            <legend>Services <input type='button' onClick="addservice();" value='+'/></legend>
            <table id='services'>
                <tr>
                    <td>Name</td>
                    <td>Quantity</td>
                    <td>Note</td>
                    <td>Specify</td>
                </tr>
                {% include 'orders/service.html' %}
            </table>
        </fieldset>
        <fieldset>
            <legend>Notes</legend>
            {{ form.groupcount }}{{ form.stylecount }}{{ form.sizecount }}{{ form.imprintcount }}{{ form.groupimprintcount }}{{ form.servicecount }}{{ form.pk }}{{ form.delete }}{{ form.note }}
        </fieldset>
    <input type='submit' value='submit'/>
    </form>
{% endblock %}

{% block sidebar %}
    <input type='button' onClick='addgroup()' value='new group'/>
{% endblock %}
